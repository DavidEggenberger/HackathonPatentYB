@inject HttpClient httpClient

<div class="container">
    <div class="UserInfoComponentContainer">
        <UserInfoComponent/>
    </div>
    <div class="diagramContainer">
        <CascadingValue Value="diagram">
            <DiagramCanvas></DiagramCanvas>
        </CascadingValue>
    </div> 
</div>

@code{
    [CascadingParameter]
    public Task<AuthenticationState> AuthState { get; set; }
    [CascadingParameter]
    public HubConnection HubConnection { get; set; }

    private Diagram diagram;
    private ApplicationUserDTO currentUserDTO = new ApplicationUserDTO();
    private List<ApplicationUserDTO> applicationUserDTOs = new List<ApplicationUserDTO>();
    private List<EnergyRessourceDTO> energyRessourceDTOs = new List<EnergyRessourceDTO>();

    protected override async Task OnInitializedAsync()
    {
        var options = new DiagramOptions
        {
            DeleteKey = "Delete",
            DefaultNodeComponent = null,
            AllowMultiSelection = true,
            AllowPanning = false,
            Zoom = new DiagramZoomOptions
            {
                Enabled = false
            },
            Links = new DiagramLinkOptions
            {
                DefaultColor = "white"
            }
        };
        diagram = new Diagram(options);
        diagram.Links.Added += b =>
        {
            b.TargetPortChanged += (bt, old, niw) =>
            {
                ((UserNode)bt.SourcePort.Parent).ConsumeRessource(((EnergyRessourceNode)bt.TargetPort.Parent).Ressource);
                StateHasChanged();
            };
        };
        diagram.RegisterModelComponent<EnergyRessourceNode, EnergyRessourceNodeComponent>();
        diagram.RegisterModelComponent<UserNode, UserNodeComponent>();

        await GetData();

        int count = 1;
        foreach (var ressource in energyRessourceDTOs)
        {
            diagram.Nodes.Add(new EnergyRessourceNode(new Point(count++ * 100, 20)));
        }

        diagram.Nodes.Add(new UserNode(httpClient, new Point(20, 30)) { ApplicationUser = currentUserDTO });



        HubConnection.On("Update", async () =>
        {
            await GetData();
        });

        StateHasChanged();
    }
    public async Task GetData()
    {
        currentUserDTO = await httpClient.GetFromJsonAsync<ApplicationUserDTO>("/api/applicationUser");
        applicationUserDTOs = await httpClient.GetFromJsonAsync<List<ApplicationUserDTO>>("/api/applicationUser/all");
        energyRessourceDTOs = await httpClient.GetFromJsonAsync<List<EnergyRessourceDTO>>("/api/energyRessource/allOffers");
    }
}
